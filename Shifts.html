<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ç­ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* ç°¡å–®çš„åˆ‡æ›å‹•ç•« */
        .page-transition { transition: all 0.3s ease-in-out; }
        .active-tab { color: #2563eb; border-top: 3px solid #2563eb; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24">

    <header class="bg-white shadow-sm sticky top-0 z-40 p-4 border-b">
        <h1 id="headerTitle" class="text-lg font-bold text-slate-800 text-center">æ’ç­ç³»çµ±</h1>
    </header>

    <main id="page-apply" class="p-4 page-transition">
        <div class="bg-blue-600 rounded-2xl shadow-lg p-6 mb-6 text-white text-center">
            <h2 id="targetMonthLabel" class="text-2xl font-black italic tracking-wider">è¼‰å…¥ä¸­...</h2>
        </div>
        <div id="calendarList" class="space-y-3">
            <div class="animate-pulse flex space-x-4 p-4 bg-white rounded-xl shadow-sm">
                <div class="rounded-full bg-slate-200 h-10 w-10"></div>
                <div class="flex-1 space-y-3 py-1">
                    <div class="h-2 bg-slate-200 rounded"></div>
                    <div class="h-2 bg-slate-200 rounded w-5/6"></div>
                </div>
            </div>
        </div>
    </main>

    <main id="page-record" class="hidden p-4 page-transition">
        <div class="bg-white rounded-2xl shadow-md p-6 mb-6 border border-slate-100">
            <label class="block text-sm font-bold text-slate-500 mb-2">æŸ¥è©¢æ’ç­</label>
            <select id="queryYM" onchange="fetchMyRecords()" class="w-full bg-slate-50 border-0 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 font-medium text-slate-700 shadow-inner">
                </select>
        </div>
        <div id="myRecordList" class="space-y-3">
            </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 flex z-50 shadow-2xl">
        <button id="tab-apply" onclick="showPage('apply')" class="flex-1 py-4 flex flex-col items-center gap-1 transition-colors">
            <span class="text-xl">ğŸ“…</span>
            <span class="text-[10px] font-bold uppercase tracking-widest">æ’ç­ç™»è¨˜</span>
        </button>
        <button id="tab-record" onclick="showPage('record')" class="flex-1 py-4 flex flex-col items-center gap-1 transition-colors">
            <span class="text-xl">ğŸ‘¤</span>
            <span class="text-[10px] font-bold uppercase tracking-widest">ç­è¡¨æŸ¥è©¢</span>
        </button>
    </nav>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxdP936FOYc0ccKaj9xUgTk23idCtlQ8gigIB3Ux2ZTR9mNwRx3AEadi0VzVqdMwhSnZQ/exec";
        const LIFF_ID = "2009203505-YoXdzhWv";
        
        let user = {};
        let counts = {}, myDates = [];
        let tYear, tMonth;

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                user = await liff.getProfile();
                
                // 1. è¨ˆç®—ä¸‹ä¸‹å€‹æœˆ
                const d = new Date();
                const target = new Date(d.getFullYear(), d.getMonth() + 2, 1);
                tYear = target.getFullYear(); tMonth = target.getMonth() + 1;
                document.getElementById('targetMonthLabel').innerText = `${tYear}å¹´ ${tMonth}æœˆ`;

                setupQueryOptions();
                await refresh(); 

                // 2. è·¯ç”±åˆ¤æ–·ï¼šæª¢æŸ¥ URL åƒæ•¸ ?page=record
                const urlParams = new URLSearchParams(window.location.search);
                const pageParam = urlParams.get('page');
                showPage(pageParam === 'record' ? 'record' : 'apply');

            } catch (err) { alert("LIFF åˆå§‹åŒ–å¤±æ•—"); }
        }

        function setupQueryOptions() {
            const sel = document.getElementById('queryYM');
            const now = new Date();
            for(let i=0; i<=2; i++) {
                let d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                let val = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`;
                let text = `${d.getFullYear()}å¹´ ${d.getMonth()+1}æœˆ`;
                sel.add(new Option(text, val));
            }
            sel.selectedIndex = 2; // é è¨­é¡¯ç¤ºä¸‹ä¸‹å€‹æœˆé¸é …
        }

        async function refresh() {
            const res = await fetch(`${GAS_URL}?action=init&lineId=${user.userId}`);
            const data = await res.json();
            counts = data.counts; myDates = data.myDates;
            renderApplyPage();
        }

        function renderApplyPage() {
            const list = document.getElementById('calendarList');
            list.innerHTML = '';
            const days = new Date(tYear, tMonth, 0).getDate();

            for(let i=1; i<=days; i++) {
                let dateStr = `${tYear}-${tMonth.toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;
                let count = counts[dateStr] || 0;
                let isMine = myDates.includes(dateStr);
                let isFull = count >= 6;
                
                let card = document.createElement('div');
                card.className = `flex justify-between items-center p-4 bg-white rounded-2xl shadow-sm border transition-all ${isMine ? 'border-blue-500 bg-blue-50' : 'border-slate-100'}`;
                card.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-lg font-black text-slate-700">${i}æ—¥</span>
                        <span class="text-[10px] font-bold ${isMine?'text-blue-600':(isFull?'text-red-500':'text-slate-400')} uppercase">
                            ${isMine ? 'â˜… å·²ç™»è¨˜' : (isFull ? 'â— æ»¿é¡' : 'åé¡: ' + (6-count))}
                        </span>
                    </div>
                    <button onclick="handle('${dateStr}', '${isMine?'cancel':'add'}')" 
                        ${isFull && !isMine ? 'disabled' : ''}
                        class="px-6 py-2 rounded-xl font-bold text-sm transition-all shadow-md ${isMine?'bg-red-500 text-white':(isFull?'bg-slate-200 text-slate-400 cursor-not-allowed':'bg-blue-600 text-white')}">
                        ${isMine ? 'å–æ¶ˆ' : (isFull ? 'æ»¿é¡' : 'ç™»è¨˜')}
                    </button>
                `;
                list.appendChild(card);
            }
        }

        async function handle(date, act) {
            const actionText = act === 'add' ? 'ç™»è¨˜' : 'å–æ¶ˆ';
            if(!confirm(`ç¢ºå®šè¦${actionText} ${date} çš„æ’ç­ï¼Ÿ`)) return;

            try {
                await fetch(GAS_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: act, date, lineId: user.userId, name: user.displayName }) 
                });
                await liff.sendMessages([{ type: 'text', text: `${act==='add'?'âœ…':'âŒ'} å·²${actionText}ï¼š${date}` }]);
                location.reload(); 
            } catch (e) { alert("é€£ç·šå¤±æ•—ï¼Œè«‹é‡è©¦"); }
        }

        function showPage(p) {
            document.getElementById('page-apply').classList.toggle('hidden', p!=='apply');
            document.getElementById('page-record').classList.toggle('hidden', p!=='record');
            
            // UI åé¥‹
            document.getElementById('tab-apply').classList.toggle('active-tab', p==='apply');
            document.getElementById('tab-record').classList.toggle('active-tab', p==='record');
            document.getElementById('headerTitle').innerText = p==='apply' ? 'æ’ç­ç™»è¨˜' : 'ç­è¡¨æŸ¥è©¢';

            if(p==='record') fetchMyRecords();
        }

        async function fetchMyRecords() {
            const ym = document.getElementById('queryYM').value;
            const res = await fetch(`${GAS_URL}?action=getMyList&lineId=${user.userId}&ym=${ym}`);
            const list = await res.json();
            
            const listEl = document.getElementById('myRecordList');
            if (list.length === 0) {
                listEl.innerHTML = `<div class="text-center py-20 text-slate-300 font-bold">ç›®å‰ç„¡æ’ç­è³‡æ–™</div>`;
            } else {
                listEl.innerHTML = list.map(d => `
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500 flex justify-between items-center">
                        <span class="font-bold text-slate-700">${d}</span>
                        <span class="text-[10px] bg-blue-100 text-blue-600 px-2 py-1 rounded-md font-bold uppercase">Confirmed</span>
                    </div>
                `).join('');
            }
        }

        init();
    </script>
</body>
</html>
