<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ç­ç³»çµ±</title>
    <style>
        :root { --primary: #2563eb; --danger: #ef4444; --slate: #64748b; --success: #22c55e; }
        body { font-family: -apple-system, sans-serif; background: #f8fafc; margin: 0; padding-bottom: 120px; }
        .p-4 { padding: 16px; }
        /* å¡ç‰‡è¨­è¨ˆ */
        .card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 12px; border: 2px solid transparent; }
        .card.selected { border-color: var(--primary); background: #eff6ff; }
        .flex { display: flex; align-items: center; justify-content: space-between; }
        /* æŒ‰éˆ•è¨­è¨ˆ */
        .btn { border: none; padding: 10px 18px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px; color: white; transition: 0.2s; }
        .btn-blue { background: var(--primary); }
        .btn-red { background: var(--danger); }
        .btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn-gray { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }
        .hidden { display: none; }
        /* å°è¦½åˆ— */
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; border-top: 1px solid #e2e8f0; padding: 10px 0; z-index: 100; }
        .nav-btn { flex: 1; text-align: center; font-size: 12px; font-weight: bold; color: var(--slate); border: none; background: none; cursor: pointer; }
        .nav-btn.active { color: var(--primary); }
        /* æ‰¹æ¬¡æ“ä½œåˆ— */
        .batch-bar { position: fixed; bottom: 80px; left: 16px; right: 16px; background: #1e293b; color: white; padding: 16px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100px); } to { transform: translateY(0); } }
        .title-card { background: var(--primary); color: white; border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 20px; }
    </style>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<div class="p-4">
    <div id="view-apply">
        <div class="title-card">
            <h1 id="monthLabel" style="margin:0; font-size:22px;">è¼‰å…¥ä¸­...</h1>
            <small id="statusHint">æ­£åœ¨æª¢æŸ¥åé¡...</small>
        </div>
        <div id="calendarList"></div>

        <div id="batchBar" class="batch-bar hidden">
            <div>å·²é¸ <span id="selectedCount" style="color:#60a5fa; font-weight:bold; font-size:18px;">0</span> å¤©</div>
            <button id="batchSubmitBtn" onclick="submitBatch()" class="btn btn-blue" style="background:#3b82f6;">æ‰¹æ¬¡ç¢ºèªç™»è¨˜</button>
        </div>
    </div>

    <div id="view-record" class="hidden">
        <div class="card">
            <select id="queryYM" onchange="fetchMyRecords()" style="width:100%; padding:10px; border-radius:8px;"></select>
        </div>
        <div id="myRecordList"></div>
    </div>
</div>

<div class="nav">
    <button class="nav-btn active" id="tab-apply" onclick="showPage('apply')"><div>ğŸ“…</div><div>æ’ç­ç™»è¨˜</div></button>
    <button class="nav-btn" id="tab-record" onclick="showPage('record')"><div>ğŸ”</div><div>ç­è¡¨æŸ¥è©¢</div></button>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxdP936FOYc0ccKaj9xUgTk23idCtlQ8gigIB3Ux2ZTR9mNwRx3AEadi0VzVqdMwhSnZQ/exec";
    const LIFF_ID = "2009203505-YoXdzhWv";
    let user = {}, counts = {}, myDates = [], selectedDates = [], tYear, tMonth;

    async function init() {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        user = await liff.getProfile();

        const d = new Date();
        const target = new Date(d.getFullYear(), d.getMonth() + 2, 1);
        tYear = target.getFullYear(); tMonth = target.getMonth() + 1;
        document.getElementById('monthLabel').innerText = `${tYear}å¹´ ${tMonth}æœˆ æ’ç­`;

        setupOptions();
        await refreshData();
        
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('page') === 'record') showPage('record');
    }

    function setupOptions() {
        const sel = document.getElementById('queryYM');
        const now = new Date();
        for(let i=0; i<=2; i++) {
            let d = new Date(now.getFullYear(), now.getMonth() + i, 1);
            let val = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,'0');
            sel.add(new Option(`${d.getFullYear()}å¹´ ${d.getMonth()+1}æœˆ`, val));
        }
        sel.selectedIndex = 2;
    }

    async function refreshData() {
        const res = await fetch(`${GAS_URL}?action=init&lineId=${user.userId}`);
        const data = await res.json();
        counts = data.counts; myDates = data.myDates;
        renderCalendar();
    }

    function renderCalendar() {
        const list = document.getElementById('calendarList');
        list.innerHTML = '';
        const days = new Date(tYear, tMonth, 0).getDate();

        for(let i=1; i<=days; i++) {
            let date = `${tYear}-${String(tMonth).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            let count = counts[date] || 0;
            let isMine = myDates.includes(date);
            let isFull = count >= 6;
            let isSelected = selectedDates.includes(date);

            const card = document.createElement('div');
            card.className = `card flex ${isSelected ? 'selected' : ''}`;
            
            let btnAction = isMine ? `cancelSingle(event, '${date}')` : `toggleSelect('${date}')`;
            let btnText = isMine ? 'å–æ¶ˆé ç´„' : (isSelected ? 'å–æ¶ˆå‹¾é¸' : (isFull ? 'å·²æ»¿é¡' : 'å‹¾é¸ç™»è¨˜'));
            let btnClass = isMine ? 'btn-red' : (isSelected ? 'btn-outline' : 'btn-blue');

            card.innerHTML = `
                <div>
                    <div style="font-size:18px; font-weight:800;">${i}æ—¥</div>
                    <div style="font-size:12px; font-weight:600; color:${isMine?'#2563eb':(isFull?'#ef4444':'#94a3b8')}">
                        ${isMine ? 'â— å·²æ’ç­' : (isFull ? 'â— äººæ•¸å·²æ»¿' : `å¯é ç´„ (å‰©${6-count})`)}
                    </div>
                </div>
                <button onclick="${btnAction}" class="btn ${btnClass}" ${isFull && !isMine ? 'disabled' : ''}>${btnText}</button>
            `;
            list.appendChild(card);
        }
    }

    function toggleSelect(date) {
        const idx = selectedDates.indexOf(date);
        if (idx > -1) selectedDates.splice(idx, 1);
        else selectedDates.push(date);
        
        document.getElementById('batchBar').classList.toggle('hidden', selectedDates.length === 0);
        document.getElementById('selectedCount').innerText = selectedDates.length;
        renderCalendar();
    }

    async function submitBatch() {
        //if (!confirm(`ç¢ºå®šè¦ç™»è¨˜é€™ ${selectedDates.length} å¤©å—ï¼Ÿ`)) return;
        const btn = document.getElementById('batchSubmitBtn');
        btn.disabled = true; btn.innerText = "æ­£åœ¨æ’éšŠå¯«å…¥...";

        try {
            const res = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'batch_add', dates: selectedDates, lineId: user.userId, name: user.displayName })
            });
            const result = await res.json();
            
            let msg = `æˆåŠŸï¼š${result.success.length} å¤©`;
            if (result.full.length > 0) msg += `\nå¤±æ•—(åé¡å‰›å¥½æ»¿äº†)ï¼š${result.full.length} å¤©`;
            alert(msg);
            
            await liff.sendMessages([{ type: 'text', text: `ğŸ“… æ’ç­çµæœå›å ±ï¼š\n${msg}` }]);
            location.reload();
        } catch (e) { alert("é€£ç·šè¶…æ™‚"); btn.disabled = false; }
    }

    async function cancelSingle(event, date) {
        if (!confirm(`ç¢ºå®šè¦å–æ¶ˆ ${date} çš„æ’ç­ï¼Ÿ`)) return;
        const btn = event.currentTarget;
        btn.disabled = true; btn.innerText = "...";
        await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'cancel', date, lineId: user.userId }) });
        location.reload();
    }

    function showPage(p) {
        document.getElementById('view-apply').classList.toggle('hidden', p!=='apply');
        document.getElementById('view-record').classList.toggle('hidden', p!=='record');
        document.getElementById('tab-apply').classList.toggle('active', p==='apply');
        document.getElementById('tab-record').classList.toggle('active', p==='record');
        if(p==='record') fetchMyRecords();
    }

    async function fetchMyRecords() {
        const ym = document.getElementById('queryYM').value;
        const res = await fetch(`${GAS_URL}?action=getMyList&lineId=${user.userId}&ym=${ym}`);
        const list = await res.json();
        document.getElementById('myRecordList').innerHTML = list.length ? list.map(d => `<div class="card flex" style="border-left:5px solid #2563eb;"><b>${d}</b><span style="color:#2563eb; font-size:12px;">å·²ç¢ºèª</span></div>`).join('') : '<p style="text-align:center; color:#94a3b8; margin-top:50px;">æŸ¥ç„¡æœ¬æœˆç­è¡¨</p>';
    }

    init();
</script>
</body>
</html>

