<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ç­å°åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-gray-100 min-h-screen pb-10">

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t flex z-50">
        <button onclick="showPage('apply')" class="flex-1 py-3 text-center font-bold text-blue-600 border-r">æˆ‘è¦æ’ç­</button>
        <button onclick="showPage('record')" class="flex-1 py-3 text-center font-bold text-gray-600">æˆ‘çš„ç´€éŒ„</button>
    </div>

    <div id="page-apply" class="p-4">
        <div class="bg-white rounded-2xl shadow p-6 mb-4 mt-2">
            <h1 id="targetMonthLabel" class="text-xl font-bold text-center">è¼‰å…¥ä¸­...</h1>
        </div>
        <div id="calendarList" class="space-y-3"></div>
    </div>

    <div id="page-record" class="hidden p-4">
        <div class="bg-white rounded-2xl shadow p-6 mb-4 mt-2">
            <h2 class="text-lg font-bold mb-3">æŸ¥è©¢å€‹äººæ’ç­</h2>
            <select id="queryYM" onchange="fetchMyRecords()" class="w-full border p-2 rounded-lg"></select>
        </div>
        <div id="myRecordList" class="space-y-2"></div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxdP936FOYc0ccKaj9xUgTk23idCtlQ8gigIB3Ux2ZTR9mNwRx3AEadi0VzVqdMwhSnZQ/exec";
        const LIFF_ID = "2009203505-YoXdzhWv";
        let user = {};
        let counts = {}, myDates = [];
        let tYear, tMonth;

        async function init() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            user = await liff.getProfile();
            
            // è¨ˆç®—ä¸‹ä¸‹å€‹æœˆ
            const d = new Date();
            const target = new Date(d.getFullYear(), d.getMonth() + 2, 1);
            tYear = target.getFullYear(); tMonth = target.getMonth() + 1;
            document.getElementById('targetMonthLabel').innerText = `ğŸ“… ${tYear}å¹´ ${tMonth}æœˆ æ’ç­ç™»è¨˜`;

            setupQueryOptions();
            refresh();
        }

        function setupQueryOptions() {
            const sel = document.getElementById('queryYM');
            const now = new Date();
            for(let i=0; i<=2; i++) {
                let d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                let val = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`;
                sel.add(new Option(`${d.getFullYear()}å¹´ ${d.getMonth()+1}æœˆ`, val));
            }
            sel.selectedIndex = 2; // é è¨­é¸ä¸­ä¸‹ä¸‹å€‹æœˆ
        }

        async function refresh() {
            const res = await fetch(`${GAS_URL}?action=init&lineId=${user.userId}`);
            const data = await res.json();
            counts = data.counts; myDates = data.myDates;
            renderApplyPage();
        }

        function renderApplyPage() {
            const list = document.getElementById('calendarList');
            list.innerHTML = '';
            const days = new Date(tYear, tMonth, 0).getDate();
            for(let i=1; i<=days; i++) {
                let date = `${tYear}-${tMonth.toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;
                let count = counts[date] || 0;
                let isMine = myDates.includes(date);
                let isFull = count >= 6;
                
                let card = document.createElement('div');
                card.className = `flex justify-between items-center p-4 bg-white rounded-xl shadow-sm border ${isMine ? 'border-blue-500 ring-1 ring-blue-500' : ''}`;
                card.innerHTML = `
                    <div><b class="text-lg">${i}æ—¥</b> <span class="text-xs ${isFull?'text-red-500':'text-blue-500'} ml-2">${isMine?'(å·²ç™»è¨˜)':(isFull?'å·²æ»¿':'å‰© '+(6-count))}</span></div>
                    <button onclick="handle('${date}', '${isMine?'cancel':'add'}')" class="px-4 py-2 rounded-lg font-bold text-white ${isMine?'bg-red-500':(isFull?'bg-gray-300':'bg-blue-600')}">${isMine?'å–æ¶ˆ':(isFull?'æ»¿é¡':'ç™»è¨˜')}</button>
                `;
                list.appendChild(card);
            }
        }

        async function handle(date, act) {
            if(!confirm(`ç¢ºå®šè¦${act==='add'?'ç™»è¨˜':'å–æ¶ˆ'} ${date}ï¼Ÿ`)) return;
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: act, date, lineId: user.userId, name: user.displayName }) });
            location.reload();
        }

        function showPage(p) {
            document.getElementById('page-apply').classList.toggle('hidden', p!=='apply');
            document.getElementById('page-record').classList.toggle('hidden', p!=='record');
            if(p==='record') fetchMyRecords();
        }

        async function fetchMyRecords() {
            const ym = document.getElementById('queryYM').value;
            const res = await fetch(`${GAS_URL}?action=getMyList&lineId=${user.userId}&ym=${ym}`);
            const list = await res.json();
            document.getElementById('myRecordList').innerHTML = list.length ? list.map(d => `<div class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-blue-500">${d}</div>`).join('') : '<p class="text-center text-gray-400 mt-10">æŸ¥ç„¡ç´€éŒ„</p>';
        }

        init();
    </script>
</body>
</html>
