const SPREADSHEET_ID = '1Y5BnieJBMR1TYfQFU-7BU267984a_tOS8J765cHe_sw';

function doGet(e) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('Shifts') || ss.insertSheet('Shifts');
  const data = sheet.getDataRange().getValues();
  const action = e.parameter.action;
  const lineId = e.parameter.lineId;
  const ym = e.parameter.ym ? e.parameter.ym.replace(/-/g, '/') : ""; // 確保 ym 也是斜線格式
  let counts = {};
  let myDates = [];

  for (let i = 1; i < data.length; i++) {
    const rowDate = data[i][0];
    if (!(rowDate instanceof Date)) continue;
    const dStr = Utilities.formatDate(new Date(rowDate), "GMT+8", "yyyy/MM/dd");
    if (dStr.startsWith(ym)) {
      counts[dStr] = (counts[dStr] || 0) + 1;
      if (data[i][2] === lineId) myDates.push(dStr);
    }
  }
  return response({ counts, myDates });
}

function doPost(e) {
  const lock = LockService.getScriptLock();
  try {
    // 嘗試鎖定，最多等待 10 秒
    lock.waitLock(10000); 
    
    const payload = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName('Shifts');
    let rows = sheet.getDataRange().getValues();

    // 批次新增模式
    if (payload.action === "batch_add") {
      let success = [], full = [];
      let dateCounts = {};
 
      rows.forEach(r => {
        if (r[0] instanceof Date) {
          let dStr = Utilities.formatDate(r[0], "GMT+8", "yyyy/MM/dd");
          dateCounts[dStr] = (dateCounts[dStr] || 0) + 1;
        }
      });

      payload.dates.forEach(date => {
        let currentCount = dateCounts[date] || 0;
        if (currentCount < 6) {
          sheet.appendRow([date, payload.name, payload.lineId, new Date()]);
          // 重要：同步更新計數地圖，避免同批次內超額
          dateCounts[date] = currentCount + 1;
          success.push(date);
        } else {
          full.push(date);
        }
      });
      return response({ result: "finished", success, full });
    }

    // 取消模式
    if (payload.action === "cancel") {
      for (let i = rows.length - 1; i >= 1; i--) {
        const rowDate = (rows[i][0] instanceof Date) ? 
                        Utilities.formatDate(rows[i][0], "GMT+8", "yyyy/MM/dd") : 
                        rows[i][0].toString().replace(/-/g, '/');
        if (rowDate === payload.date && rows[i][2] === payload.lineId) {
          sheet.deleteRow(i + 1);
          return response({ result: "ok" });
        }
      }
      return response({ result: "not_found" });
    }
  } catch (err) {
    return response({ result: "error", msg: "系統忙碌" });
  } finally {
    lock.releaseLock();
  }
}
function response(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}
