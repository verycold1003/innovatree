<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ç­ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-slate-50 min-h-screen">

    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-3xl shadow-xl p-6 mb-4 border border-slate-100 mt-4">
            <h1 id="monthTitle" class="text-2xl font-black text-slate-800 text-center">è¼‰å…¥ä¸­...</h1>
        </div>

        <div id="dateList" class="space-y-3 pb-20">
            <div class="flex justify-center py-10">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxdP936FOYc0ccKaj9xUgTk23idCtlQ8gigIB3Ux2ZTR9mNwRx3AEadi0VzVqdMwhSnZQ/exec";
        const LIFF_ID = "2009203505-YoXdzhWv";
        
        let userProfile = {};
        let shiftCounts = {};
        let myRegistrations = [];
        let targetYear, targetMonth;

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                userProfile = await liff.getProfile();
                
                // 1. è¨­å®šä¸‹ä¸‹å€‹æœˆæ—¥æœŸ
                const now = new Date();
                const targetDate = new Date(now.getFullYear(), now.getMonth() + 2, 1);
                targetYear = targetDate.getFullYear();
                targetMonth = targetDate.getMonth() + 1;
                document.getElementById('monthTitle').innerText = `ğŸ“… ${targetYear}å¹´ ${targetMonth}æœˆ æ’ç­ç™»è¨˜`;

                // 2. ç²å–è³‡æ–™ä¸¦æ¸²æŸ“
                await refreshData();
            } catch (err) {
                alert("åˆå§‹åŒ–å¤±æ•—: " + err);
            }
        }

        async function refreshData() {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            shiftCounts = data.counts;
            myRegistrations = data.raw;
            renderCalendar();
        }

        function renderCalendar() {
            const listEl = document.getElementById('dateList');
            listEl.innerHTML = '';
            
            const daysInMonth = new Date(targetYear, targetMonth, 0).getDate();
            const currentUserId = userProfile.userId;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${targetYear}-${targetMonth.toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
                const count = shiftCounts[dateKey] || 0;
                const isMine = myRegistrations.includes(`${dateKey}_${currentUserId}`);
                const isFull = count >= 6;

                const card = document.createElement('div');
                card.className = `flex justify-between items-center p-4 rounded-2xl border transition-all ${
                    isMine ? 'bg-blue-50 border-blue-200 ring-1 ring-blue-200' : 
                    (isFull ? 'bg-slate-50 border-slate-200 opacity-70' : 'bg-white border-slate-100 shadow-sm')
                }`;

                let statusLabel = isMine ? 'ğŸ”µ å·²ç™»è¨˜' : (isFull ? 'ğŸ”´ å·²æ»¿é¡' : `ğŸŸ¢ å‰©é¤˜ ${6 - count} åé¡`);
                let btnText = isMine ? 'å–æ¶ˆ' : (isFull ? 'æ»¿é¡' : 'ç™»è¨˜');
                let btnColor = isMine ? 'bg-red-500 shadow-red-100' : (isFull ? 'bg-slate-300' : 'bg-blue-600 shadow-blue-100');
                let onClick = isMine ? `handleAction('${dateKey}', 'cancel')` : `handleAction('${dateKey}', 'add')`;

                card.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-lg font-bold text-slate-700">${d}æ—¥</span>
                        <span class="text-xs font-semibold ${isMine ? 'text-blue-600' : (isFull ? 'text-red-400' : 'text-slate-400')}">${statusLabel}</span>
                    </div>
                    <button onclick="${onClick}" ${isFull && !isMine ? 'disabled' : ''} 
                        class="px-6 py-2 rounded-xl font-bold text-white transition-all active:scale-95 shadow-lg ${btnColor}">
                        ${btnText}
                    </button>
                `;
                listEl.appendChild(card);
            }
        }

        async function handleAction(date, action) {
            const confirmMsg = action === 'cancel' ? `ç¢ºå®šè¦å–æ¶ˆ ${date} çš„æ’ç­å—ï¼Ÿ` : `ç¢ºå®šè¦ç™»è¨˜ ${date} çš„æ’ç­å—ï¼Ÿ`;
            if (!confirm(confirmMsg)) return;

            const payload = {
                action: action,
                date: date,
                name: userProfile.displayName,
                lineId: userProfile.userId
            };

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const resData = await response.json();
                
                if (resData.result) {
                    const lineMsg = action === 'cancel' ? `âŒ å·²å–æ¶ˆ ${date} çš„æ’ç­` : `âœ… å·²æˆåŠŸç™»è¨˜ ${date} çš„æ’ç­`;
                    await liff.sendMessages([{ type: 'text', text: lineMsg }]);
                    alert("æ“ä½œæˆåŠŸï¼");
                    location.reload(); 
                }
            } catch (err) {
                alert("æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
        }

        main();
    </script>
</body>
</html>

