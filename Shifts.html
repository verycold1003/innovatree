<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊéíÁè≠Á≥ªÁµ±</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f8fafc; margin: 0; padding-bottom: 80px; }
        .p-4 { padding: 16px; }
        .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 12px; }
        .flex { display: flex; align-items: center; justify-content: space-between; }
        .btn { border: none; padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; }
        .btn-blue { background: #2563eb; }
        .btn-red { background: #ef4444; }
        .btn-gray { background: #cbd5e1; color: #64748b; }
        .hidden { display: none; }
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; border-top: 1px solid #e2e8f0; }
        .nav-btn { flex: 1; padding: 15px; text-align: center; font-size: 12px; font-weight: bold; color: #64748b; text-decoration: none; cursor: pointer; }
        .active { color: #2563eb; border-top: 2px solid #2563eb; }
        .title { font-size: 24px; font-weight: 800; text-align: center; color: #1e293b; margin: 0; }
    </style>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

    <div class="p-4" id="main-ui">

        <div id="view-apply">
            <div class="card" style="background: #2563eb; color: white;">
                <h1 id="monthLabel" class="title" style="color: white;">ËºâÂÖ•‰∏≠...</h1>
            </div>
            <div id="calendarList"></div>
        </div>

        <div id="view-record" class="hidden">
            <div class="card">
                <select id="queryYM" onchange="fetchMyRecords()" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;"></select>
            </div>
            <div id="myRecordList"></div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-btn active" id="tab-apply" onclick="showPage('apply')">
            <div style="font-size: 20px;">üìÖ</div><div>ÊéíÁè≠ÁôªË®ò</div>
        </div>
        <div class="nav-btn" id="tab-record" onclick="showPage('record')">
            <div style="font-size: 20px;">üîç</div><div>Áè≠Ë°®Êü•Ë©¢</div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxdP936FOYc0ccKaj9xUgTk23idCtlQ8gigIB3Ux2ZTR9mNwRx3AEadi0VzVqdMwhSnZQ/exec";
        const LIFF_ID = "2009203505-YoXdzhWv";
        let user = {}, counts = {}, myDates = [], tYear, tMonth;

        async function init() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            user = await liff.getProfile();

            const d = new Date();
            const target = new Date(d.getFullYear(), d.getMonth() + 2, 1);
            tYear = target.getFullYear(); tMonth = target.getMonth() + 1;
            document.getElementById('monthLabel').innerText = tYear + "Âπ¥ " + tMonth + "Êúà ÊéíÁè≠ÁôªË®ò";

            setupOptions();
            await refresh();

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('page') === 'record') showPage('record');
        }

        function setupOptions() {
            const sel = document.getElementById('queryYM');
            const now = new Date();
            for(let i=0; i<=2; i++) {
                let d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                let val = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, '0');
                sel.add(new Option(d.getFullYear() + "Âπ¥ " + (d.getMonth()+1) + "Êúà", val));
            }
            sel.selectedIndex = 2;
        }

        async function refresh() {
            const res = await fetch(GAS_URL + "?action=init&lineId=" + user.userId);
            const data = await res.json();
            counts = data.counts; myDates = data.myDates;
            renderCalendar();
        }

        function renderCalendar() {
            const list = document.getElementById('calendarList');
            list.innerHTML = '';
            const days = new Date(tYear, tMonth, 0).getDate();
            for(let i=1; i<=days; i++) {
                let date = tYear + "-" + String(tMonth).padStart(2, '0') + "-" + String(i).padStart(2, '0');
                let count = counts[date] || 0;
                let isMine = myDates.includes(date);
                let isFull = count >= 6;
                
                let div = document.createElement('div');
                div.className = "card flex";
                div.innerHTML = `
                    <div><b style="font-size: 18px;">${i}Êó•</b><br><small style="color:${isMine?'#2563eb':(isFull?'#ef4444':'#64748b')}">${isMine?'Â∑≤ÁôªË®ò':(isFull?'Â∑≤ÊªøÈ°ç':'Ââ©È§ò '+(6-count))}</small></div>
                    <button onclick="handle('${date}', '${isMine?'cancel':'add'}')" class="btn ${isMine?'btn-red':(isFull?'btn-gray':'btn-blue')}" ${isFull && !isMine?'disabled':''}>${isMine?'ÂèñÊ∂à':(isFull?'ÊªøÈ°ç':'ÁôªË®ò')}</button>
                `;
                list.appendChild(div);
            }
        }

        async function handle(date, act) {
            //if(!confirm("Á¢∫ÂÆöË¶Å" + (act==='add'?'ÁôªË®ò':'ÂèñÊ∂à') + " " + date + "?")) return;
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: act, date: date, lineId: user.userId, name: user.displayName }) });
            await liff.sendMessages([{ type: 'text', text: (act==='add'?'‚úÖ':'‚ùå') + " Â∑≤ÂÆåÊàê" + (act==='add'?'ÁôªË®ò':'ÂèñÊ∂à') + "Ôºö" + date }]);
            location.reload();
        }

        function showPage(p) {
            document.getElementById('view-apply').classList.toggle('hidden', p!=='apply');
            document.getElementById('view-record').classList.toggle('hidden', p!=='record');
            document.getElementById('tab-apply').classList.toggle('active', p==='apply');
            document.getElementById('tab-record').classList.toggle('active', p==='record');
            if(p==='record') fetchMyRecords();
        }

        async function fetchMyRecords() {
            const ym = document.getElementById('queryYM').value;
            const res = await fetch(GAS_URL + "?action=getMyList&lineId=" + user.userId + "&ym=" + ym);
            const list = await res.json();
            document.getElementById('myRecordList').innerHTML = list.length ? list.map(d => `<div class="card" style="border-left: 5px solid #2563eb;"><b>${d}</b></div>`).join('') : '<p style="text-align:center;color:#94a3b8;margin-top:50px;">Êü•ÁÑ°Áè≠Ë°®</p>';
        }

        init();
    </script>
</body>
</html>


