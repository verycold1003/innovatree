<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ç­ç³»çµ±</title>
    <style>
        :root { --primary: #2563eb; --danger: #ef4444; --slate: #64748b; --weekend: #dc2626; }
        body { font-family: -apple-system, sans-serif; background: #f8fafc; margin: 0; padding-bottom: 120px; }
        .p-4 { padding: 16px; }
        .card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 12px; border: 2px solid transparent; }
        .card.selected { border-color: var(--primary); background: #eff6ff; }
        .flex { display: flex; align-items: center; justify-content: space-between; }
        .btn { border: none; padding: 10px 18px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px; color: white; transition: 0.2s; }
        .btn-blue { background: var(--primary); }
        .btn-red { background: var(--danger); }
        .btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .hidden { display: none; }
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; border-top: 1px solid #e2e8f0; padding: 10px 0; z-index: 100; }
        .nav-btn { flex: 1; text-align: center; font-size: 12px; font-weight: bold; color: var(--slate); border: none; background: none; cursor: pointer; }
        .nav-btn.active { color: var(--primary); }
        .batch-bar { position: fixed; bottom: 80px; left: 16px; right: 16px; background: #1e293b; color: white; padding: 16px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 99; }
        .title-card { background: var(--primary); color: white; border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .day-text { font-size: 18px; font-weight: 800; color: #1e293b; }
        .week-text { font-size: 14px; margin-left: 6px; color: var(--slate); font-weight: 600; }
        .is-weekend { color: var(--weekend) !important; }
        .loading-spinner { text-align: center; padding: 50px; color: var(--slate); font-weight: bold; }
        /* æç¤ºå­—éæ¸¡ */
        #statusHint { transition: opacity 0.5s ease; }
    </style>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<div class="p-4">
    <div id="view-apply">
        <div class="title-card">
            <h1 id="monthLabel" style="margin:0; font-size:22px;">è¼‰å…¥ä¸­...</h1>
            <small id="statusHint">æ­£åœ¨æª¢æŸ¥åé¡...</small>
        </div>
        <div id="calendarList"></div>
        <div id="batchBar" class="batch-bar hidden">
            <div>å·²é¸ <span id="selectedCount" style="color:#60a5fa; font-weight:bold; font-size:18px;">0</span> å¤©</div>
            <button id="batchSubmitBtn" onclick="submitBatch()" class="btn btn-blue" style="background:#3b82f6;">ç¢ºèªç™»è¨˜</button>
        </div>
    </div>

    <div id="view-record" class="hidden">
        <div class="card">
            <h2 style="margin-top:0; font-size:18px;">ç­è¡¨æŸ¥è©¢</h2>
            <select id="queryYM" onchange="fetchMyRecords()" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;"></select>
        </div>
        <div id="myRecordList"></div>
    </div>
</div>

<div class="nav">
    <button class="nav-btn active" id="tab-apply" onclick="showPage('apply')"><div>ğŸ“…</div><div>æ’ç­ç™»è¨˜</div></button>
    <button class="nav-btn" id="tab-record" onclick="showPage('record')"><div>ğŸ”</div><div>ç­è¡¨æŸ¥è©¢</div></button>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxdP936FOYc0ccKaj9xUgTk23idCtlQ8gigIB3Ux2ZTR9mNwRx3AEadi0VzVqdMwhSnZQ/exec";
    const LIFF_ID = "2009203505-YoXdzhWv";
    let user = {}, counts = {}, myDates = [], selectedDates = [], tYear, tMonth;
    const weekMap = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];

    async function init() {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        user = await liff.getProfile();

        const d = new Date();
        const target = new Date(d.getFullYear(), d.getMonth() + 2, 1);
        tYear = target.getFullYear(); tMonth = target.getMonth() + 1;
        document.getElementById('monthLabel').innerText = `${tYear}å¹´ ${tMonth}æœˆ æ’ç­`;

        setupOptions();
        await refreshData();
        
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('page') === 'record') showPage('record');
    }

    function setupOptions() {
        const sel = document.getElementById('queryYM');
        const now = new Date();
        for(let i=0; i<=2; i++) {
            let d = new Date(now.getFullYear(), now.getMonth() + i, 1);
            let val = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,'0');
            sel.add(new Option(`${d.getFullYear()}å¹´ ${d.getMonth()+1}æœˆ`, val));
        }
        sel.selectedIndex = 2;
    }

    async function refreshData() {
        const hint = document.getElementById('statusHint');
        try {
            const res = await fetch(`${GAS_URL}?action=init&lineId=${user.userId}`);
            const data = await res.json();
            counts = data.counts; 
            myDates = data.myDates;
            renderCalendar();
            
            setTimeout(() => {
                hint.style.opacity = "0";
                setTimeout(() => { hint.style.display = "none"; }, 500);
            }, 2000);
        } catch (e) {
            // hint.innerText = "è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
        }
    }

    function renderCalendar() {
        const list = document.getElementById('calendarList');
        list.innerHTML = '';
        const days = new Date(tYear, tMonth, 0).getDate();

        for(let i=1; i<=days; i++) {
            let date = `${tYear}-${String(tMonth).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            let count = counts[date] || 0;
            let isMine = myDates.includes(date);
            let isFull = count >= 6;
            let isSelected = selectedDates.includes(date);

            const d = new Date(tYear, tMonth - 1, i);
            const weekDay = weekMap[d.getDay()];
            const isWeekend = (d.getDay() === 0 || d.getDay() === 6);

            const card = document.createElement('div');
            card.className = `card flex ${isSelected ? 'selected' : ''}`;
            
            let btnAction = isMine ? `cancelSingle(event, '${date}')` : `toggleSelect('${date}')`;
            let btnText = isMine ? 'å–æ¶ˆé ç´„' : (isSelected ? 'å–æ¶ˆé¸å–' : (isFull ? 'å·²æ»¿é¡' : 'é¸å–'));
            let btnClass = isMine ? 'btn-red' : (isSelected ? 'btn-outline' : 'btn-blue');

            card.innerHTML = `
                <div>
                    <div>
                        <span class="day-text">${i}æ—¥</span>
                        <span class="week-text ${isWeekend ? 'is-weekend' : ''}">${weekDay}</span>
                    </div>
                    <div style="font-size:12px; font-weight:600; color:${isMine?'#2563eb':(isFull?'#ef4444':'#94a3b8')}">
                        ${isMine ? 'â— å·²æ’ç­' : (isFull ? 'â— äººæ•¸å·²æ»¿' : `å¯é ç´„ (å‰©${6-count})`)}
                    </div>
                </div>
                <button onclick="${btnAction}" class="btn ${btnClass}" ${isFull && !isMine ? 'disabled' : ''}>${btnText}</button>
            `;
            list.appendChild(card);
        }
    }

    function toggleSelect(date) {
        const idx = selectedDates.indexOf(date);
        if (idx > -1) selectedDates.splice(idx, 1);
        else selectedDates.push(date);
        const bar = document.getElementById('batchBar');
        bar.classList.toggle('hidden', selectedDates.length === 0);
        document.getElementById('selectedCount').innerText = selectedDates.length;
        renderCalendar();
    }

    async function submitBatch() {
        const btn = document.getElementById('batchSubmitBtn');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "è™•ç†ä¸­...";
        btn.style.opacity = "0.5";
        btn.style.cursor = "not-allowed";

        try {
            const res = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: 'batch_add', 
                    dates: selectedDates, 
                    lineId: user.userId, 
                    name: user.displayName 
                })
            });
            const result = await res.json();
            let msg = `âœ… æˆåŠŸç™»è¨˜ï¼š${result.success.length} å¤©`;
            if (result.full.length > 0) msg += `\nâš ï¸ é¡æ»¿å¤±æ•—ï¼š${result.full.length} å¤©`;
            
            await liff.sendMessages([{
                type: 'text',
                text: `ğŸ“… æ’ç­çµæœï¼š\n${msg}\næ—¥æœŸï¼š${result.success.join(', ')}`
            }]);
            location.reload(); 
        } catch (e) {
            btn.disabled = false;
            btn.innerText = originalText;
            btn.style.opacity = "1";
            btn.style.cursor = "pointer";
            // alert("ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹é‡æ–°å˜—è©¦");
        }
    }

    async function cancelSingle(event, date) {
        const btn = event.currentTarget;
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "è™•ç†ä¸­...";
        btn.style.opacity = "0.5";
        btn.style.cursor = "not-allowed";

        try {
            await fetch(GAS_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'cancel', date, lineId: user.userId }) 
            });
            await liff.sendMessages([{ type: 'text', text: `âŒ å·²å–æ¶ˆæ’ç­ï¼š${date}` }]);
            location.reload();
        } catch (e) {
            btn.disabled = false;
            btn.innerText = originalText;
            btn.style.opacity = "1";
            btn.style.cursor = "pointer";
        }
    }
    
    function showPage(p) {
        document.getElementById('view-apply').classList.toggle('hidden', p!=='apply');
        document.getElementById('view-record').classList.toggle('hidden', p!=='record');
        document.getElementById('tab-apply').classList.toggle('active', p==='apply');
        document.getElementById('tab-record').classList.toggle('active', p==='record');
        if (p !== 'apply') document.getElementById('batchBar').classList.add('hidden');
        else if (selectedDates.length > 0) document.getElementById('batchBar').classList.remove('hidden');
        if(p==='record') fetchMyRecords();
    }

    async function fetchMyRecords() {
        const listEl = document.getElementById('myRecordList');
        listEl.innerHTML = '<div class="loading-spinner">â³ æ­£åœ¨æŸ¥è©¢ç­è¡¨...</div>';
        const ym = document.getElementById('queryYM').value;
        try {
            const res = await fetch(`${GAS_URL}?action=init&lineId=${user.userId}`);
            const data = await res.json();
            const ymDates = data.myDates.filter(d => d.startsWith(ym));
            
            listEl.innerHTML = ymDates.length ? ymDates.map(d => {
                const dateObj = new Date(d);
                const w = weekMap[dateObj.getDay()];
                const isW = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
                return `
                    <div class="card flex" style="border-left:5px solid #2563eb;">
                        <div>
                            <b>${d}</b>
                            <small style="margin-left:8px; color:${isW?'#dc2626':'#64748b'}; font-weight:bold;">${w}</small>
                        </div>
                    </div>
                `;
            }).join('') : '<div style="text-align:center; color:#94a3b8; margin-top:50px;">æŸ¥ç„¡ç­è¡¨</div>';
        } catch(e) { 
            listEl.innerHTML = '<div style="text-align:center; color:red; margin-top:50px;">æŸ¥è©¢å¤±æ•—</div>'; 
        }
    }

    init();
</script>
</body>
</html>
