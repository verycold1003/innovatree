<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>排班系統</title>
    <style>
        :root { --primary: #2563eb; --danger: #ef4444; --slate: #64748b; }
        body { font-family: -apple-system, system-ui, sans-serif; background: #f1f5f9; margin: 0; padding-bottom: 90px; color: #1e293b; }
        .p-4 { padding: 16px; }
        .card { background: white; border-radius: 16px; padding: 18px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 12px; transition: transform 0.1s; }
        .flex { display: flex; align-items: center; justify-content: space-between; }
        .btn { border: none; padding: 12px 24px; border-radius: 12px; font-weight: 700; cursor: pointer; color: white; transition: all 0.2s; font-size: 14px; }
        .btn:disabled { background: #cbd5e1 !important; color: #94a3b8 !important; cursor: not-allowed; opacity: 0.7; }
        .btn-blue { background: var(--primary); box-shadow: 0 4px 14px 0 rgba(37,99,235,0.39); }
        .btn-red { background: var(--danger); }
        .hidden { display: none; }
        /* 底部導覽列 */
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); display: flex; border-top: 1px solid #e2e8f0; padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { flex: 1; padding: 12px; text-align: center; font-size: 11px; font-weight: bold; color: var(--slate); cursor: pointer; border: none; background: none; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn svg { width: 24px; height: 24px; margin-bottom: 4px; }
        /* 標題 */
        .header-card { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; border-radius: 20px; padding: 24px; margin-bottom: 20px; text-align: center; }
        .title { font-size: 22px; font-weight: 800; margin: 0; letter-spacing: 1px; }
        select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 16px; background: white; }
    </style>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

    <div class="p-4" id="app">

        <div id="view-apply">
            <div class="header-card">
                <h1 id="monthLabel" class="title">讀取中...</h1>
                <div id="loadingStatus" style="font-size: 12px; margin-top: 8px; opacity: 0.8;">正在同步雲端資料...</div>
            </div>
            <div id="calendarList">
                <div class="card" style="height: 60px; opacity: 0.5; background: #e2e8f0;"></div>
                <div class="card" style="height: 60px; opacity: 0.3; background: #e2e8f0;"></div>
            </div>
        </div>

        <div id="view-record" class="hidden">
            <div class="card">
                <label style="display:block; margin-bottom:8px; font-weight:bold; color:var(--slate);">選擇月份</label>
                <select id="queryYM" onchange="fetchMyRecords()"></select>
            </div>
            <div id="myRecordList"></div>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn active" id="tab-apply" onclick="showPage('apply')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            <div>排班登記</div>
        </button>
        <button class="nav-btn" id="tab-record" onclick="showPage('record')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <div>班表查詢</div>
        </button>
    </div>

    <script>
        // --- 請修改以下資訊 ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxdP936FOYc0ccKaj9xUgTk23idCtlQ8gigIB3Ux2ZTR9mNwRx3AEadi0VzVqdMwhSnZQ/exec";
        const LIFF_ID = "2009203505-YoXdzhWv";
        
        let user = {}, counts = {}, myDates = [], tYear, tMonth;

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                user = await liff.getProfile();

                // 計算下下個月
                const d = new Date();
                const target = new Date(d.getFullYear(), d.getMonth() + 2, 1);
                tYear = target.getFullYear(); tMonth = target.getMonth() + 1;
                document.getElementById('monthLabel').innerText = tYear + "年 " + tMonth + "月";

                setupOptions();
                await refreshData();

                // 處理路由
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('page') === 'record') showPage('record');
                
                document.getElementById('loadingStatus').innerText = "資料已同步";
            } catch (err) {
                console.error(err);
                document.getElementById('loadingStatus').innerText = "連線失敗，請重新開啟";
            }
        }

        function setupOptions() {
            const sel = document.getElementById('queryYM');
            const now = new Date();
            for(let i=0; i<=2; i++) {
                let d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                let val = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, '0');
                sel.add(new Option(d.getFullYear() + "年 " + (d.getMonth()+1) + "月", val));
            }
            sel.selectedIndex = 2; // 預設為下下個月
        }

        async function refreshData() {
            const res = await fetch(`${GAS_URL}?action=init&lineId=${user.userId}`);
            const data = await res.json();
            counts = data.counts; 
            myDates = data.myDates;
            renderCalendar();
        }

        function renderCalendar() {
            const list = document.getElementById('calendarList');
            list.innerHTML = '';
            const days = new Date(tYear, tMonth, 0).getDate();
            
            for(let i=1; i<=days; i++) {
                let dateStr = tYear + "-" + String(tMonth).padStart(2, '0') + "-" + String(i).padStart(2, '0');
                let count = counts[dateStr] || 0;
                let isMine = myDates.includes(dateStr);
                let isFull = count >= 6;
                
                const card = document.createElement('div');
                card.className = "card flex";
                card.innerHTML = `
                    <div style="flex:1">
                        <div style="font-size: 18px; font-weight: 800;">${i}日</div>
                        <div style="font-size: 12px; font-weight: 600; color:${isMine?'#2563eb':(isFull?'#ef4444':'#94a3b8')}">
                            ${isMine ? '● 您已預約' : (isFull ? '● 人數已滿' : '可預約 (剩餘 ' + (6-count) + ')')}
                        </div>
                    </div>
                    <button onclick="handleAction(event, '${dateStr}', '${isMine?'cancel':'add'}')" 
                        class="btn ${isMine?'btn-red':'btn-blue'}" 
                        ${isFull && !isMine ? 'disabled' : ''}>
                        ${isMine ? '取消預約' : (isFull ? '名額已滿' : '立即登記')}
                    </button>
                `;
                list.appendChild(card);
            }
        }

        async function handleAction(event, date, act) {
            const btn = event.currentTarget;
            const originalText = btn.innerText;

            //if(!confirm(`確認要 ${act==='add'?'登記':'取消'} ${date} 的排班嗎？`)) return;

            // --- 立即禁用按鈕防止重複點擊 ---
            btn.disabled = true;
            btn.innerText = "處理中...";

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: act,
                        date: date,
                        lineId: user.userId,
                        name: user.displayName
                    })
                });

                // 發送 LINE 通知
                const msg = act === 'add' ? `✅ 登記成功：${date}` : `❌ 已取消：${date}`;
                await liff.sendMessages([{ type: 'text', text: msg }]);
                
                // 強制重新載入
                location.href = window.location.origin + window.location.pathname + "?page=" + (act==='add'?'apply':'record');
            } catch (e) {
                alert("系統繁忙，請稍後再試");
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        function showPage(p) {
            document.getElementById('view-apply').classList.toggle('hidden', p !== 'apply');
            document.getElementById('view-record').classList.toggle('hidden', p !== 'record');
            document.getElementById('tab-apply').classList.toggle('active', p === 'apply');
            document.getElementById('tab-record').classList.toggle('active', p === 'record');
            if(p === 'record') fetchMyRecords();
        }

        async function fetchMyRecords() {
            const ym = document.getElementById('queryYM').value;
            const res = await fetch(`${GAS_URL}?action=getMyList&lineId=${user.userId}&ym=${ym}`);
            const list = await res.json();
            
            const listEl = document.getElementById('myRecordList');
            if(list.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; padding:50px; color:#94a3b8;">此月份無登記紀錄</div>';
            } else {
                listEl.innerHTML = list.map(d => `
                    <div class="card flex" style="border-left: 5px solid #2563eb;">
                        <span style="font-weight:bold;">${d}</span>
                        <span style="font-size:12px; color:#2563eb; font-weight:bold;">已確認</span>
                    </div>
                `).join('');
            }
        }

        init();
    </script>
</body>
</html>
